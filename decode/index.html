<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>ABI Calldata Decoder Improved</title>
</head>
<body>
<h3>ABI Calldata Decoder with Dynamic Data</h3>
<textarea id="inputHex" rows="10" cols="100" placeholder="Paste calldata hex here"></textarea><br><br>
<button onclick="decodeABI()">Decode</button>
<pre id="output"></pre>

<script>
function hexToBytes(hex) {
    hex = hex.replace(/^0x/, '');
    let bytes = [];
    for (let i=0; i<hex.length; i+=2) {
        bytes.push(parseInt(hex.substr(i,2),16));
    }
    return bytes;
}

function bytesToHex(bytes) {
    return '0x' + bytes.map(b => b.toString(16).padStart(2,'0')).join('');
}

function readUint256(bytes, start) {
    return BigInt('0x'+bytes.slice(start,start+32).map(b => b.toString(16).padStart(2,'0')).join(''));
}

function decodeABI() {
    const hex = document.getElementById('inputHex').value.trim();
    if (!hex.startsWith('0x')) {
        alert('Hex must start with 0x');
        return;
    }
    const bytes = hexToBytes(hex);
    if (bytes.length < 4) {
        alert('Hex too short');
        return;
    }

    const selector = bytes.slice(0,4);
    const params = bytes.slice(4);
    const paramCount = Math.floor(params.length / 32);

    let out = `Function selector: ${bytesToHex(selector)}\n\nParameters:\n`;

    // Threshold for offset detection: minimal offset 32 (start of params area)
    const MIN_OFFSET = 32;

    for(let i=0; i<paramCount; i++) {
        const paramStart = i*32;
        const paramBytes = params.slice(paramStart,paramStart+32);
        const val = readUint256(params,paramStart);

        // Check if value looks like offset to dynamic data inside params
        if (val >= BigInt(MIN_OFFSET) && val < BigInt(params.length)) {
            // Read length of dynamic data at offset
            const offset = Number(val);
            const len = Number(readUint256(params, offset));
            const dataStart = offset + 32;
            const dataEnd = dataStart + len;

            if (dataEnd > params.length) {
                out += `Param ${i}: Invalid dynamic data length or offset\n`;
            } else {
                const dataBytes = params.slice(dataStart, dataEnd);
                out += `Param ${i} (dynamic data, offset ${offset}, length ${len}):\n  ${bytesToHex(dataBytes)}\n`;
            }
        } else {
            // Treat as static uint256/address/bytes32
            out += `Param ${i} (static): ${bytesToHex(paramBytes)}\n`;
        }
    }
    document.getElementById('output').textContent = out;
}
</script>
</body>
</html>
