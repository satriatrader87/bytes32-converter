<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Calldata Multi-field Decoder</title>
</head>
<body>
<h3>Calldata Multi-field Decoder</h3>
<textarea id="inputHex" rows="8" cols="100" placeholder="Paste calldata hex here..."></textarea><br><br>
<button onclick="decodeCalldata()">Decode</button>
<pre id="output"></pre>

<script>
function hexToBytes(hex) {
    hex = hex.replace(/^0x/, '');
    let bytes = [];
    for (let c = 0; c < hex.length; c += 2) {
        bytes.push(parseInt(hex.substr(c, 2), 16));
    }
    return bytes;
}

function bytesToHex(bytes) {
    return '0x' + bytes.map(b => b.toString(16).padStart(2, '0')).join('');
}

function readUint256(bytes, start) {
    return BigInt('0x' + bytes.slice(start, start + 32).map(b => b.toString(16).padStart(2, '0')).join(''));
}

function decodeCalldata() {
    let hex = document.getElementById("inputHex").value.trim();
    if (!hex.startsWith("0x")) {
        alert("Hex must start with 0x");
        return;
    }

    let bytes = hexToBytes(hex);
    let selector = bytes.slice(0, 4);
    let params = bytes.slice(4);

    let output = `Function selector: ${bytesToHex(selector)}\n\nParameters:\n`;

    // hitung jumlah slot parameter (anggap setiap param 32 byte di awal)
    let numParams = Math.floor(params.length / 32);
    let offsetsToDecode = [];

    for (let i = 0; i < numParams; i++) {
        let paramBytes = params.slice(i * 32, (i + 1) * 32);
        let asNumber = readUint256(params, i * 32);

        // cek apakah ini offset ke data dinamis
        if (asNumber > 0 && asNumber < params.length) {
            output += `Param ${i} (offset to dynamic data): ${asNumber}\n`;
            offsetsToDecode.push({ index: i, offset: Number(asNumber) });
        } else {
            output += `Param ${i} (static value): ${bytesToHex(paramBytes)}\n`;
        }
    }

    output += `\nDynamic Data:\n`;
    offsetsToDecode.forEach(({ index, offset }) => {
        let length = Number(readUint256(params, offset));
        let dataStart = offset + 32;
        let dataEnd = dataStart + length;
        let dataBytes = params.slice(dataStart, dataEnd);
        output += `Param ${index} length: ${length}\n`;
        output += `Param ${index} data: ${bytesToHex(dataBytes)}\n\n`;
    });

    document.getElementById("output").textContent = output;
}
</script>
</body>
</html>
